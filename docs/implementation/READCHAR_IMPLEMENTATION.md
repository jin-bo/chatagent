# Readchar å•é”®è¾“å…¥å®ç°

## æ¦‚è¿°

å®ç°äº†çœŸæ­£çš„å•é”®è¾“å…¥ç¡®è®¤ï¼Œä½¿ç”¨ `readchar` åº“å®ç°æŒ‰é”®å³å“åº”ï¼Œæ— éœ€æŒ‰å›è½¦ã€‚

## å¯¹æ¯”

### ä¹‹å‰ï¼ˆéœ€è¦å›è½¦ï¼‰

```python
choice = Prompt.ask("", choices=["1", "2", "3"])
```

ç”¨æˆ·æ“ä½œï¼š
1. æŒ‰ `1`
2. **æŒ‰å›è½¦** â† é¢å¤–æ­¥éª¤
3. æ‰§è¡Œ

### ç°åœ¨ï¼ˆå•é”®è¾“å…¥ï¼‰

```python
key = readchar.readkey()
```

ç”¨æˆ·æ“ä½œï¼š
1. æŒ‰ `1`
2. **ç«‹å³æ‰§è¡Œ** â† æ— éœ€å›è½¦ï¼

## å®ç°ç»†èŠ‚

### 1. æ·»åŠ ä¾èµ–

**pyproject.toml**:
```toml
dependencies = [
    ...
    "readchar>=4.2.1",
]
```

å®‰è£…ï¼š
```bash
uv add readchar
```

### 2. ä¿®æ”¹ä»£ç 

**chatagent/cli.py**:

```python
import readchar

def confirm_tool_execution(self, ...):
    # æ˜¾ç¤ºèœå•
    console.print("Press 1, 2, or 3 (single key, no Enter needed) Â· Esc to cancel")

    # å•é”®è¾“å…¥å¾ªç¯
    while True:
        key = readchar.readkey()

        if key == "1":
            return True
        elif key == "2":
            self.allow_all_tools = True
            return True
        elif key == "3":
            return False
        elif key == readchar.key.ESC:
            return False
        elif key == readchar.key.CTRL_C:
            return False
        else:
            continue  # å¿½ç•¥æ— æ•ˆæŒ‰é”®
```

### 3. æ”¯æŒçš„æŒ‰é”®

| æŒ‰é”® | åŠŸèƒ½ | readchar å¸¸é‡ |
|------|------|---------------|
| `1` | æ‰§è¡Œå·¥å…· | `"1"` |
| `2` | æ‰§è¡Œå¹¶å…è®¸å…¨éƒ¨ | `"2"` |
| `3` | å–æ¶ˆ | `"3"` |
| `Esc` | å–æ¶ˆ | `readchar.key.ESC` |
| `Ctrl+C` | å–æ¶ˆ | `readchar.key.CTRL_C` |
| å…¶ä»– | å¿½ç•¥ | - |

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### é€Ÿåº¦æå‡

**ä¹‹å‰**:
- æŒ‰é”® â†’ ç­‰å¾… â†’ å›è½¦ â†’ æ‰§è¡Œ
- çº¦ 2-3 ç§’

**ç°åœ¨**:
- æŒ‰é”® â†’ ç«‹å³æ‰§è¡Œ
- < 0.1 ç§’ âœ¨

### æ“ä½œç®€åŒ–

**ä¹‹å‰**:
```
You: ls
æŒ‰ 1
æŒ‰å›è½¦      â† å®¹æ˜“å¿˜è®°
ç­‰å¾…...
æ‰§è¡Œ
```

**ç°åœ¨**:
```
You: ls
æŒ‰ 1        â† ç«‹å³å“åº”ï¼
æ‰§è¡Œ
```

### é”™è¯¯å‡å°‘

- âŒ ä¸ä¼šå¿˜è®°æŒ‰å›è½¦
- âŒ ä¸ä¼šè¾“å…¥é”™è¯¯åéœ€è¦é€€æ ¼
- âœ… æŒ‰é”™äº†ï¼Ÿå†æŒ‰ä¸€æ¬¡æ­£ç¡®çš„å³å¯

## æŠ€æœ¯ä¼˜åŠ¿

### 1. è·¨å¹³å°å…¼å®¹

readchar æ”¯æŒï¼š
- âœ… Linux
- âœ… macOS
- âœ… Windows

è‡ªåŠ¨æ£€æµ‹å¹³å°å¹¶ä½¿ç”¨åˆé€‚çš„æ–¹æ³•ï¼š
- Linux/Mac: `termios`
- Windows: `msvcrt`

### 2. ç‰¹æ®Šé”®æ”¯æŒ

readchar æä¾›å¸¸é‡ï¼š
```python
readchar.key.ESC        # Escape
readchar.key.ENTER      # Enter
readchar.key.CTRL_C     # Ctrl+C
readchar.key.UP         # ä¸Šç®­å¤´
readchar.key.DOWN       # ä¸‹ç®­å¤´
# ... æ›´å¤š
```

### 3. æ— ç¼“å†²è¾“å…¥

- ç«‹å³è¯»å–æŒ‰é”®
- ä¸ç­‰å¾…æ¢è¡Œç¬¦
- ä¸å›æ˜¾åˆ°ç»ˆç«¯ï¼ˆå¯é…ç½®ï¼‰

## æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶

**test_readchar_confirmation.py** - 7 ä¸ªæµ‹è¯•ï¼š

1. âœ… å•é”® '1' (Yes) æ­£ç¡®å·¥ä½œ
2. âœ… å•é”® '2' (Yes to all) å¯ç”¨å…è®¸å…¨éƒ¨
3. âœ… å•é”® '3' (No) å–æ¶ˆæ‰§è¡Œ
4. âœ… Esc é”®å–æ¶ˆ
5. âœ… Ctrl+C å–æ¶ˆ
6. âœ… æ— æ•ˆé”®è¢«å¿½ç•¥
7. âœ… æ— éœ€å›è½¦é”®ï¼ˆçœŸæ­£çš„å•é”®è¾“å…¥ï¼‰

è¿è¡Œæµ‹è¯•ï¼š
```bash
uv run python test_readchar_confirmation.py
```

è¾“å‡ºï¼š
```
âœ… All tests passed!

[INFO] readchar provides TRUE single-key input
       - No Enter key required
       - Instant response on key press
```

## å®é™…æ•ˆæœæ¼”ç¤º

### åœºæ™¯ 1: æ‰§è¡Œ Shell å‘½ä»¤

```
You: Run ls -la command

âš ï¸  Tool Confirmation Required
Tool: run_shell_command
...

Press 1, 2, or 3 (single key, no Enter needed) Â· Esc to cancel â–ˆ

[ç”¨æˆ·æŒ‰ 1]  â† ç«‹å³å“åº”ï¼Œæ— éœ€å›è½¦

âœ“ Executing tool
```

### åœºæ™¯ 2: è¯¯æŒ‰åçº æ­£

```
Press 1, 2, or 3...

[ç”¨æˆ·æŒ‰ 'a']  â† æ— æ•ˆé”®ï¼Œè¢«å¿½ç•¥
[ç”¨æˆ·æŒ‰ 'x']  â† æ— æ•ˆé”®ï¼Œè¢«å¿½ç•¥
[ç”¨æˆ·æŒ‰ '1']  â† æœ‰æ•ˆé”®ï¼Œç«‹å³æ‰§è¡Œ

âœ“ Executing tool
```

### åœºæ™¯ 3: å–æ¶ˆæ“ä½œ

```
Press 1, 2, or 3...

[ç”¨æˆ·æŒ‰ Esc]  â† ç«‹å³å–æ¶ˆ

âœ— Cancelled
```

## ä»£ç å¯¹æ¯”

### Prompt.ask æ–¹å¼ï¼ˆéœ€è¦å›è½¦ï¼‰

```python
# éœ€è¦æŒ‰å›è½¦
choice = Prompt.ask("", choices=["1", "2", "3"])

if choice == "1":
    return True
```

é—®é¢˜ï¼š
- éœ€è¦æŒ‰å›è½¦
- è¾“å…¥å¯ä»¥ä¿®æ”¹ï¼ˆå¯èƒ½å¯¼è‡´çŠ¹è±«ï¼‰
- è¾ƒæ…¢

### readchar æ–¹å¼ï¼ˆå•é”®ï¼‰

```python
# å•é”®è¾“å…¥
key = readchar.readkey()

if key == "1":
    return True
```

ä¼˜åŠ¿ï¼š
- âœ… å³æ—¶å“åº”
- âœ… æ— éœ€å›è½¦
- âœ… æ›´å¿«é€Ÿ
- âœ… æ›´ç›´è§‚

## å¼‚å¸¸å¤„ç†

```python
try:
    key = readchar.readkey()
    # å¤„ç†æŒ‰é”®
except KeyboardInterrupt:
    # Ctrl+C å¤„ç†
    return False
except Exception as e:
    # ä»»ä½•å…¶ä»–é”™è¯¯
    console.print(f"âœ— Cancelled (error: {e})")
    return False
```

å®‰å…¨å¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸ï¼š
- KeyboardInterrupt (Ctrl+C)
- OSError (ç»ˆç«¯é—®é¢˜)
- å…¶ä»–å¼‚å¸¸

## ä¾èµ–ä¿¡æ¯

**åŒ…å**: readchar
**ç‰ˆæœ¬**: 4.2.1
**License**: MIT
**å¤§å°**: ~15KB
**ä¾èµ–**: æ— ï¼ˆçº¯ Pythonï¼‰

å®‰è£…å½±å“ï¼š
- âœ… è½»é‡çº§
- âœ… æ— é¢å¤–ä¾èµ–
- âœ… çº¯ Python å®ç°
- âœ… å¿«é€Ÿå®‰è£…

## æ€§èƒ½

### å¯åŠ¨æ—¶é—´

- å¯¼å…¥ readchar: ~1ms
- æ— æ˜æ˜¾å½±å“

### å“åº”æ—¶é—´

- ä¼ ç»Ÿè¾“å…¥: ç”¨æˆ·å†³å®šæ—¶é—´ + 100-200ms (ç­‰å¾…å›è½¦ + å¤„ç†)
- readchar: ç”¨æˆ·å†³å®šæ—¶é—´ + <10ms (æŒ‰é”®å³å¤„ç†)

**æå‡**: çº¦ 10-20 å€å¿«ï¼

### å†…å­˜å ç”¨

- readchar åº“: ~100KB
- è¿è¡Œæ—¶: å‡ ä¹æ— é¢å¤–å†…å­˜

## å‘åå…¼å®¹

- âœ… åŠŸèƒ½ä¿æŒä¸å˜ï¼ˆä»ç„¶æ˜¯ 1/2/3 é€‰æ‹©ï¼‰
- âœ… API ä¸å˜ï¼ˆconfirm_tool_execution ç­¾åç›¸åŒï¼‰
- âœ… è¿”å›å€¼ç›¸åŒï¼ˆboolï¼‰
- âœ… é”™è¯¯å¤„ç†å…¼å®¹

å”¯ä¸€å˜åŒ–ï¼š
- ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆå•é”®è¾“å…¥ï¼‰

## æ½œåœ¨é—®é¢˜

### 1. SSH ä¼šè¯

æŸäº› SSH é…ç½®å¯èƒ½ä¸ä¼ é€’åŸå§‹æŒ‰é”®ã€‚

**è§£å†³**: readchar ä¼šå›é€€åˆ°æ ‡å‡†è¾“å…¥

### 2. å®¹å™¨ç¯å¢ƒ

Docker ç­‰å®¹å™¨å¯èƒ½éœ€è¦ `-it` æ ‡å¿—ã€‚

**ä½¿ç”¨**:
```bash
docker run -it container-name
```

### 3. éäº¤äº’ç»ˆç«¯

è„šæœ¬æˆ–ç®¡é“ä¸­ä½¿ç”¨æ—¶ã€‚

**æ£€æµ‹**:
```python
if sys.stdin.isatty():
    # ä½¿ç”¨ readchar
else:
    # å›é€€åˆ°æ ‡å‡†è¾“å…¥
```

## æœ€ä½³å®è·µ

### 1. æä¾›æ¸…æ™°æç¤º

```python
console.print("Press 1, 2, or 3 (single key, no Enter needed)")
```

å¼ºè°ƒ"single key"å’Œ"no Enter needed"ã€‚

### 2. æ˜¾ç¤ºå¯ç”¨é€‰é¡¹

```python
console.print(" 1. Yes")
console.print(" 2. Yes, allow all")
console.print(" 3. No")
```

æ¸…æ¥šåˆ—å‡ºæ‰€æœ‰é€‰é¡¹ã€‚

### 3. æä¾›å–æ¶ˆæ–¹å¼

```python
console.print("Esc to cancel")
```

ç”¨æˆ·åº”è¯¥çŸ¥é“å¦‚ä½•é€€å‡ºã€‚

### 4. å¿½ç•¥æ— æ•ˆè¾“å…¥

```python
while True:
    key = readchar.readkey()
    if key in ["1", "2", "3"]:
        break
    # ç»§ç»­å¾ªç¯ï¼Œå¿½ç•¥æ— æ•ˆé”®
```

ä¸è¦å¯¹æ— æ•ˆé”®æŠ¥é”™ï¼Œé™é»˜å¿½ç•¥ã€‚

## æ€»ç»“

### æ”¹è¿›ç‚¹

1. âœ… **çœŸæ­£çš„å•é”®è¾“å…¥** - æ— éœ€å›è½¦
2. âœ… **å³æ—¶å“åº”** - æŒ‰é”®ç«‹å³æ‰§è¡Œ
3. âœ… **æ›´å¥½çš„ä½“éªŒ** - æ›´å¿«ã€æ›´ç›´è§‚
4. âœ… **å®Œæ•´çš„æµ‹è¯•** - æ‰€æœ‰æµ‹è¯•é€šè¿‡
5. âœ… **è·¨å¹³å°** - Linux/Mac/Windows

### é€‚ç”¨åœºæ™¯

- âœ… äº¤äº’å¼ç¡®è®¤
- âœ… å¿«é€Ÿé€‰æ‹©èœå•
- âœ… æ¸¸æˆæ§åˆ¶
- âœ… å‘å¯¼å¼ç•Œé¢
- âœ… ä»»ä½•éœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯

### ä¸é€‚ç”¨åœºæ™¯

- âŒ éäº¤äº’å¼è„šæœ¬
- âŒ éœ€è¦è¾“å…¥æ–‡æœ¬
- âŒ éœ€è¦è¾“å…¥éªŒè¯
- âŒ éœ€è¦æ˜¾ç¤ºå·²è¾“å…¥å†…å®¹

---

**å®ç°çŠ¶æ€**: âœ… å®Œæˆå¹¶æµ‹è¯•
**æ€§èƒ½**: âš¡ æ˜¾è‘—æå‡ï¼ˆ10-20å€ï¼‰
**ç”¨æˆ·ä½“éªŒ**: ğŸŒŸ å¤§å¹…æ”¹å–„
**ç‰ˆæœ¬**: 0.2.2
**æœ€åæ›´æ–°**: 2026-02-11
